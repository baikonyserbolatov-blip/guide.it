<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trello Cyberpunk — Dark Modern Trello Clone</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =========================
   Trello Cyberpunk - Dark Modern Theme
   Single-file frontend (HTML + CSS + JS)
   Theme: Black + Blue Cyberpunk
   ========================= */

/* ---- Variables ---- */
:root{
  --bg-1: #03040a;
  --bg-2: #071426;
  --panel: rgba(18,24,40,0.6);
  --glass: rgba(255,255,255,0.04);
  --neon-1: #00e5ff; /* cyan */
  --neon-2: #5b7cff; /* blue */
  --accent: linear-gradient(90deg,var(--neon-1),var(--neon-2));
  --muted: #9aa7bf;
  --success: #2ee6a7;
  --danger: #ff6b6b;
  --radius: 12px;
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.6);
  --glass-border: rgba(255,255,255,0.06);
  --glass-2: rgba(11,16,33,0.6);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* ---- Reset ---- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background: radial-gradient(1200px 800px at 10% 10%, rgba(11,20,40,0.4), transparent 2%),
              radial-gradient(900px 600px at 85% 80%, rgba(45,10,90,0.18), transparent 2%),
              linear-gradient(180deg,var(--bg-1),var(--bg-2));
  color:#e6eef8;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-size:14px;
  line-height:1.4;
  padding:28px;
}

/* ---- App container ---- */
.app {
  max-width:1300px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:18px;
}

/* ---- Header ---- */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand {
  display:flex;
  gap:14px;
  align-items:center;
}
.logo {
  width:56px;height:56px;border-radius:14px;
  background:linear-gradient(135deg,#021428 0%, rgba(43,12,90,0.45) 100%);
  border:1px solid var(--glass-border);
  box-shadow:0 8px 26px rgba(91,124,255,0.08), inset 0 -6px 24px rgba(0,0,0,0.6);
  display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--neon-1);font-size:20px;
  position:relative;overflow:hidden;
}
.logo::after{
  content:"";position:absolute;inset:0;background:linear-gradient(120deg, rgba(0,200,255,0.04), rgba(91,124,255,0.02));mix-blend-mode:overlay;
}
.title {
  display:flex;flex-direction:column;
}
.title .main { font-weight:800;font-size:18px;letter-spacing:0.2px; color:#dff6ff; }
.title .sub { font-size:12px;color:var(--muted);margin-top:2px }

/* ---- Top controls ---- */
.top-controls { display:flex;gap:10px;align-items:center; }
.search {
  display:flex;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:6px 8px;border:1px solid rgba(255,255,255,0.03);
}
.search input {
  background:transparent;border:0;color:var(--muted);outline:none;padding:8px;width:240px;
}
.pulse {
  width:10px;height:10px;border-radius:50%;background:var(--neon-1);box-shadow:0 0 12px var(--neon-1),0 0 26px var(--neon-2);margin-right:8px;
}

/* ---- Main body: dashboard / board ---- */
.main {
  display:flex;
  gap:18px;
  align-items:flex-start;
}

/* ---- Sidebar ---- */
.sidebar {
  width:260px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
  border-radius:16px;
  padding:16px;
  border:1px solid var(--glass-border);
  box-shadow: var(--shadow-lg);
  position:sticky; top:28px;
  height:calc(100vh - 140px);
  overflow:auto;
}
.user {
  display:flex;gap:12px;align-items:center;margin-bottom:12px;
}
.avatar {
  width:46px;height:46px;border-radius:10px;background:linear-gradient(90deg,var(--neon-2),var(--neon-1));display:flex;align-items:center;justify-content:center;font-weight:800;color:#02122a;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,0.5);
}
.user .info { display:flex;flex-direction:column }
.user .name { font-weight:700 }
.user .email { color:var(--muted);font-size:12px }

/* ---- Buttons ---- */
.btn {
  background:linear-gradient(90deg,var(--neon-1),var(--neon-2));
  color:#02122a;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;
  box-shadow:0 8px 30px rgba(59,124,255,0.06);
}
.btn.ghost {
  background:transparent;color:var(--neon-1);border:1px solid rgba(255,255,255,0.04);
}
.btn.small { padding:6px 8px;font-size:13px;border-radius:8px; }

/* ---- Boards list in sidebar ---- */
.section-title { color:var(--muted);font-size:12px;margin-top:8px;margin-bottom:6px }
.boards-list { display:flex;flex-direction:column;gap:10px }
.board-link {
  padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:700;display:flex;justify-content:space-between;align-items:center;
}
.board-link.active { box-shadow:0 10px 30px rgba(91,124,255,0.06);border-left:4px solid var(--neon-1) }

/* ---- Workspace area ---- */
.workspace { flex:1; display:flex;flex-direction:column;gap:12px; }
.panel {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:14px;padding:12px;border:1px solid var(--glass-border); box-shadow: var(--shadow-lg);
}

/* ---- Boards Grid (dashboard) ---- */
.boards-grid {
  display:grid;
  grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
  gap:14px;
}
.board-card {
  border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.02);
  min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;
  transition:transform .18s ease, box-shadow .18s ease;
}
.board-card:hover { transform:translateY(-6px); box-shadow:0 18px 60px rgba(11,20,40,0.7) }
.board-card .meta { color:var(--muted);font-size:12px }

/* ---- Board view (columns) ---- */
.board-header { display:flex;align-items:center;gap:12px }
.board-title { font-weight:800;font-size:20px;color:linear-gradient(90deg,#fff,#d8f9ff) }
.board-actions { margin-left:auto;display:flex;gap:8px;align-items:center }

.columns {
  display:flex;gap:14px;align-items:flex-start;padding:12px; overflow:auto;
}
.column {
  min-width:300px;
  max-width:320px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);
  display:flex;flex-direction:column;gap:10px;height:70vh;
}
.col-header { display:flex;align-items:center;gap:8px }
.col-title { font-weight:800 }
.cards { overflow:auto; display:flex;flex-direction:column;gap:10px;padding:6px }
.card {
  background: linear-gradient(180deg, rgba(10,14,22,0.8), rgba(19,24,36,0.7));
  border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);cursor:grab;
  box-shadow: 0 8px 30px rgba(11,20,40,0.7);
}
.card:hover { transform: translateY(-4px); transition: transform .12s ease }
.card .title { font-weight:700 }
.card .meta { font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:8px;align-items:center }

/* ---- Add UI ---- */
.add-column {
  min-width:260px;background:transparent;border:2px dashed rgba(91,124,255,0.06);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;color:var(--muted);
  cursor:pointer;
}

/* ---- Modal ---- */
.modal {
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85));z-index:9999;
}
.modal.show { display:flex }
.modal-card {
  width:560px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 18px 80px rgba(0,0,0,0.8);
}
.input, textarea, select {
  width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);
  outline:none;margin-top:8px;
}
textarea { min-height:120px; resize:vertical }

/* ---- Tiny helpers ---- */
.row{display:flex;gap:8px;align-items:center}
.kv{font-weight:700;color:var(--muted)}
.label{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(91,124,255,0.08);color:var(--neon-2);font-weight:700;font-size:12px}

/* ---- Footer / activity ---- */
.activity { margin-top:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);max-height:200px;overflow:auto }

/* ---- Responsive ---- */
@media (max-width:980px){
  .main { flex-direction:column }
  .sidebar { position:static; height:auto; order:2 }
  .workspace { order:1 }
  .columns { flex-wrap:nowrap; overflow:auto }
}

/* ========================= */
</style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="brand">
      <div class="logo">T•P</div>
      <div class="title">
        <div class="main">Trello Cyberpunk</div>
        <div class="sub">Dark Modern • Black + Blue • Demo</div>
      </div>
    </div>

    <div class="top-controls">
      <div class="search">
        <div class="pulse"></div>
        <input id="globalSearch" placeholder="Search boards, cards..." />
      </div>
      <button id="btnExport" class="btn small">Export</button>
      <button id="btnImport" class="btn small ghost">Import</button>
      <input id="fileInput" type="file" accept=".json" style="display:none" />
    </div>
  </header>

  <div class="main">
    <aside class="sidebar panel">
      <div class="user">
        <div class="avatar" id="avatar">A</div>
        <div class="info">
          <div class="name" id="userName">Guest</div>
          <div class="email" id="userEmail">not logged</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="btnNewBoard" class="btn">+ New Board</button>
        <button id="btnLogin" class="btn ghost" style="margin-left:auto">Login</button>
      </div>

      <div class="section-title">Your Boards</div>
      <div id="boardsList" class="boards-list"></div>

      <div style="margin-top:12px">
        <div class="section-title">Activity</div>
        <div id="activity" class="activity"></div>
      </div>
    </aside>

    <section class="workspace">
      <div id="dashPanel" class="panel" style="min-height:120px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-weight:800;font-size:18px">Dashboard</div>
          <div style="color:var(--muted);font-size:13px">All your boards</div>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:12px" id="boardsGrid" class="boards-grid"></div>
      </div>

      <div id="boardPanel" class="panel" style="display:none">
        <div class="board-header">
          <div>
            <div id="boardTitle" class="board-title">Board Title</div>
            <div style="color:var(--muted);font-size:13px" id="boardDesc">Board description</div>
          </div>
          <div class="board-actions">
            <button id="btnBack" class="btn small ghost">Back</button>
            <button id="btnAddList" class="btn small">+ List</button>
            <button id="btnBoardExport" class="btn small ghost">Export</button>
            <button id="btnBoardOptions" class="btn small ghost">Options</button>
          </div>
        </div>

        <div class="columns" id="columnsContainer"></div>
      </div>
    </section>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal" role="dialog">
  <div class="modal-card" id="modalCard"></div>
</div>

<script>
/* =========================
   Trello Cyberpunk - JS
   Single-file frontend logic
   Features:
   - localStorage persistence
   - Users (local)
   - Boards, lists, cards
   - drag & drop
   - modals
   - export/import
   - BroadcastChannel sync
   - activity log
   ========================= */

/* ---------- Utilities ---------- */
const uid = (len=8) => Math.random().toString(36).slice(2,2+len);
const now = () => new Date().toISOString();
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const show = el => el && (el.style.display = '');
const hide = el => el && (el.style.display = 'none');
const el = id => document.getElementById(id);

/* ---------- Storage keys ---------- */
const KEY_USERS = 'tc_users_v1';
const KEY_CUR = 'tc_current_v1';
const KEY_ACT = 'tc_activity_v1';

/* ---------- State ---------- */
let users = JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
let current = JSON.parse(localStorage.getItem(KEY_CUR) || 'null'); // { email }
let activity = JSON.parse(localStorage.getItem(KEY_ACT) || '[]');

/* BroadcastChannel for tab sync */
let bc = null;
if ('BroadcastChannel' in window) {
  try {
    bc = new BroadcastChannel('tc_channel');
    bc.onmessage = (e) => handleBroadcast(e.data);
  } catch (e){ bc = null; }
}
window.addEventListener('storage', (e)=>{
  if (e.key === 'tc_sync_event') {
    try { handleBroadcast(JSON.parse(e.newValue)); } catch(e){}
  }
});

/* DOM refs */
const boardsListRef = el('boardsList');
const boardsGridRef = el('boardsGrid');
const activityRef = el('activity');
const avatarRef = el('avatar');
const userNameRef = el('userName');
const userEmailRef = el('userEmail');

const dashPanel = el('dashPanel');
const boardPanel = el('boardPanel');
const boardTitleRef = el('boardTitle');
const boardDescRef = el('boardDesc');
const columnsContainer = el('columnsContainer');

/* Buttons */
const btnNewBoard = el('btnNewBoard');
const btnLogin = el('btnLogin');
const btnExport = el('btnExport');
const btnImport = el('btnImport');
const fileInput = el('fileInput');
const btnBack = el('btnBack');
const btnAddList = el('btnAddList');
const btnBoardExport = el('btnBoardExport');
const btnBoardOptions = el('btnBoardOptions');

/* Modal helpers */
const modal = el('modal');
const modalCard = el('modalCard');
function openModal(html) {
  modalCard.innerHTML = html;
  modal.classList.add('show');
}
function closeModal() {
  modal.classList.remove('show');
  modalCard.innerHTML = '';
}
modal.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

/* ---------- Helpers: persistence ---------- */
function saveUsers(){ localStorage.setItem(KEY_USERS, JSON.stringify(users)); }
function saveCurrent(){ localStorage.setItem(KEY_CUR, JSON.stringify(current)); }
function saveActivity(){ localStorage.setItem(KEY_ACT, JSON.stringify(activity)); }

function broadcast(payload){
  if (bc) try { bc.postMessage(payload); } catch(e){}
  try { localStorage.setItem('tc_sync_event', JSON.stringify({ ...payload, ts: Date.now() })); } catch(e){}
}

function logActivity(actor, action, payload){
  const entry = { id: uid(6), actor, action, payload, ts: now() };
  activity.unshift(entry);
  if (activity.length>500) activity.pop();
  saveActivity();
  renderActivity();
}

/* ---------- Auth (local only, demo-safe) ---------- */
function findUser(email){ return users.find(u=>u.email === email); }
function register(name, email, password){
  email = email.trim().toLowerCase();
  if (!email || !password) throw new Error('Email and password required');
  if (findUser(email)) throw new Error('User already exists');
  const user = { id: uid(6), name: name || email.split('@')[0], email, password, boards: [], createdAt: now() };
  users.push(user); saveUsers();
  logActivity(email, 'register', {});
  return user;
}
function login(email, password){
  email = email.trim().toLowerCase();
  const user = findUser(email);
  if (!user || user.password !== password) throw new Error('Invalid credentials');
  current = { email: user.email }; saveCurrent();
  logActivity(user.email, 'login', {});
  broadcast({ type:'auth', email:user.email, action:'login' });
  return user;
}
function logout(){
  if (!current) return;
  logActivity(current.email, 'logout', {});
  broadcast({ type:'auth', email:current.email, action:'logout' });
  current = null; saveCurrent();
  renderUI();
}

/* ---------- Initial demo user ---------- */
function ensureDemo(){
  if (!findUser('demo@local')) {
    const u = { id: uid(6), name: 'Demo', email:'demo@local', password:'demo', boards:[], createdAt: now() };
    // create sample board
    const b = { id: uid(7), title:'Cyber Project', desc:'A demo cyberpunk board', createdAt: now(), lists: [] };
    const l1 = { id: uid(6), title:'Backlog', position:0, cards: [ { id: uid(6), title:'Design neon UI', desc:'Make it glowy', labels:['ui'], comments:[], due:null, createdAt:now() } ] };
    const l2 = { id: uid(6), title:'In Progress', position:1, cards:[] };
    const l3 = { id: uid(6), title:'Done', position:2, cards:[] };
    b.lists.push(l1,l2,l3);
    u.boards.push(b);
    users.push(u);
    saveUsers();
  }
}
ensureDemo();

/* ---------- Render Activity ---------- */
function renderActivity(){
  activityRef.innerHTML = '';
  activity.slice(0,50).forEach(a=>{
    const d = document.createElement('div');
    d.style.padding = '6px 8px'; d.style.borderBottom = '1px dashed rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${escapeHtml(a.actor)}</div><div style="color:var(--muted);font-size:13px">${escapeHtml(a.action)} • ${new Date(a.ts).toLocaleString()}</div>`;
    activityRef.appendChild(d);
  });
}
renderActivity();

/* ---------- Render sidebar boards & dashboard ---------- */
function renderSidebarBoards(){
  boardsListRef.innerHTML = '';
  if (!current) return;
  const user = findUser(current.email);
  if (!user) return;
  (user.boards || []).forEach(b=>{
    const node = document.createElement('div'); node.className = 'board-link'; node.dataset.id = b.id;
    node.innerHTML = `<div style="display:flex;flex-direction:column"><div style="font-weight:800">${escapeHtml(b.title)}</div><div style="color:var(--muted);font-size:12px">${(b.lists||[]).length} lists</div></div><div style="display:flex;gap:8px"><button class="btn small ghost open">Open</button></div>`;
    node.querySelector('.open').addEventListener('click', ()=> openBoard(b.id));
    boardsListRef.appendChild(node);
  });
}

/* Dashboard boards grid */
function renderBoardsGrid(){
  boardsGridRef.innerHTML = '';
  if (!current) return;
  const user = findUser(current.email);
  if (!user) return;
  const boards = user.boards || [];
  boards.forEach(b=>{
    const card = document.createElement('div'); card.className = 'board-card';
    card.innerHTML = `<div><div style="font-weight:800">${escapeHtml(b.title)}</div><div style="color:var(--muted);font-size:12px">${escapeHtml(b.desc||'')}</div></div><div style="display:flex;justify-content:space-between;align-items:center"><div class="meta">${(b.lists||[]).length} lists</div><div style="display:flex;gap:6px"><button class="btn small ghost open">Open</button><button class="btn small ghost opt">…</button></div></div>`;
    card.querySelector('.open').addEventListener('click', ()=> openBoard(b.id));
    card.querySelector('.opt').addEventListener('click', ()=> showBoardOptions(b));
    boardsGridRef.appendChild(card);
  });
}

/* ---------- Render UI depending on auth ---------- */
function renderUI(){
  if (current && findUser(current.email)){
    // logged
    const u = findUser(current.email);
    avatarRef.textContent = (u.name||u.email)[0].toUpperCase();
    userNameRef.textContent = u.name;
    userEmailRef.textContent = u.email;
    btnLogin.textContent = 'Logout';
    btnLogin.onclick = ()=> { logout(); };
    renderSidebarBoards();
    renderBoardsGrid();
    hide(el('boardPanel'));
    show(el('dashPanel'));
  } else {
    // logged out
    avatarRef.textContent = 'G';
    userNameRef.textContent = 'Guest';
    userEmailRef.textContent = 'not logged';
    btnLogin.textContent = 'Login';
    btnLogin.onclick = ()=> showLoginModal();
    boardsListRef.innerHTML = `<div style="color:var(--muted);font-size:13px">Login or register to see boards</div>`;
    boardsGridRef.innerHTML = `<div style="grid-column:1/-1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);color:var(--muted)">Please login to manage boards</div>`;
    show(el('dashPanel')); hide(el('boardPanel'));
  }
}
renderUI();

/* ---------- Board operations ---------- */
function createBoard(title, desc){
  if (!current) return alert('Login required');
  const user = findUser(current.email);
  const b = { id: uid(7), title, desc, createdAt: now(), lists: [] };
  // default lists
  const l1 = { id: uid(6), title:'Backlog', position:0, cards:[] };
  const l2 = { id: uid(6), title:'In Progress', position:1, cards:[] };
  const l3 = { id: uid(6), title:'Done', position:2, cards:[] };
  b.lists.push(l1,l2,l3);
  user.boards.push(b); saveUsers();
  logActivity(user.email,'create_board',{boardId:b.id, title});
  broadcast({ type:'boards_changed', email:user.email });
  renderSidebarBoards(); renderBoardsGrid();
  openBoard(b.id);
  return b;
}

function openBoard(boardId){
  if (!current) return alert('Login required');
  const u = findUser(current.email);
  const b = (u.boards||[]).find(x=>x.id===boardId);
  if (!b) return alert('Board not found');
  boardTitleRef.textContent = b.title;
  boardDescRef.textContent = b.desc || '';
  hide(dashPanel);
  show(boardPanel);
  renderBoardColumns(b);
  logActivity(u.email,'open_board',{boardId});
}

/* render columns and cards */
function renderBoardColumns(board){
  columnsContainer.innerHTML = '';
  (board.lists||[]).sort((a,b)=> (a.position||0) - (b.position||0)).forEach(list=>{
    const col = document.createElement('div'); col.className = 'column'; col.dataset.listId = list.id;
    col.innerHTML = `<div class="col-header"><div class="col-title">${escapeHtml(list.title)}</div><div style="display:flex;gap:6px"><button class="btn small ghost add-card">+ Card</button><button class="btn small ghost del-list">✕</button></div></div><div class="cards"></div>`;
    const cardsWrap = col.querySelector('.cards');
    (list.cards||[]).forEach(card=>{
      const c = document.createElement('div'); c.className='card'; c.draggable=true; c.dataset.cardId = card.id;
      c.innerHTML = `<div class="title">${escapeHtml(card.title)}</div><div class="meta">${escapeHtml(card.desc||'')}</div>`;
      // events
      c.addEventListener('dragstart', (ev)=> {
        ev.dataTransfer.setData('text/plain', JSON.stringify({ fromList:list.id, cardId:card.id }));
        c.classList.add('dragging');
      });
      c.addEventListener('dragend', ()=> c.classList.remove('dragging'));
      c.addEventListener('dblclick', ()=> openCardModal(board.id, list.id, card.id));
      cardsWrap.appendChild(c);
    });
    // add-card and delete list
    col.querySelector('.add-card').addEventListener('click', ()=> openAddCardModal(board, list));
    col.querySelector('.del-list').addEventListener('click', ()=> {
      if (!confirm('Delete list?')) return;
      deleteList(board.id, list.id);
    });

    // drag/drop handlers
    col.addEventListener('dragover', (e)=> { e.preventDefault(); col.style.outline = '2px dashed rgba(91,124,255,0.12)'; });
    col.addEventListener('dragleave', ()=> { col.style.outline = ''; });
    col.addEventListener('drop', (e)=> {
      e.preventDefault(); col.style.outline = '';
      try {
        const payload = JSON.parse(e.dataTransfer.getData('text/plain'));
        moveCard(board.id, payload.fromList, list.id, payload.cardId);
      } catch (err){ console.error(err); }
    });

    columnsContainer.appendChild(col);
  });

  // add column box
  const addCol = document.createElement('div'); addCol.className='add-column'; addCol.innerHTML = '+ Add column';
  addCol.addEventListener('click', ()=> openAddListModal(board));
  columnsContainer.appendChild(addCol);
}

/* ---------- CRUD functions ---------- */
function addList(boardId, title){
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId);
  const list = { id: uid(6), title, position: (b.lists.length||0), cards:[] };
  b.lists.push(list); saveUsers();
  logActivity(u.email,'add_list',{boardId,listId:list.id});
  broadcast({ type:'boards_changed', email:u.email });
  renderBoardColumns(b);
}
function deleteList(boardId, listId){
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId);
  b.lists = b.lists.filter(l=>l.id!==listId); saveUsers();
  logActivity(u.email,'delete_list',{boardId,listId}); broadcast({ type:'boards_changed', email:u.email });
  renderBoardColumns(b);
}
function addCard(boardId, listId, title, desc=''){
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId);
  const list = b.lists.find(l=>l.id===listId);
  const card = { id: uid(7), title, desc, labels:[], comments:[], due:null, createdAt: now() };
  list.cards.push(card); saveUsers();
  logActivity(u.email,'add_card',{boardId,listId,cardId:card.id});
  broadcast({ type:'boards_changed', email:u.email });
  renderBoardColumns(b);
}
function deleteCard(boardId, listId, cardId){
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId);
  const list = b.lists.find(l=>l.id===listId);
  list.cards = list.cards.filter(c=>c.id!==cardId); saveUsers();
  logActivity(u.email,'delete_card',{boardId,listId,cardId}); broadcast({ type:'boards_changed', email:u.email });
  renderBoardColumns(b);
}
function moveCard(boardId, fromListId, toListId, cardId){
  if (fromListId === toListId) return;
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId);
  const from = b.lists.find(l=>l.id===fromListId); const to = b.lists.find(l=>l.id===toListId);
  const idx = from.cards.findIndex(c=>c.id===cardId); if (idx<0) return;
  const [card] = from.cards.splice(idx,1); to.cards.push(card); saveUsers();
  logActivity(u.email,'move_card',{boardId,fromListId,toListId,cardId}); broadcast({ type:'boards_changed', email:u.email });
  renderBoardColumns(b);
}

/* ---------- Modal Forms ---------- */
function openLoginModal(){
  openModal(`<h3>Login</h3>
    <div><input id="mEmail" class="input" placeholder="Email" /></div>
    <div><input id="mPass" class="input" placeholder="Password" type="password" /></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="mLogin" class="btn">Login</button><button id="mReg" class="btn ghost">Register</button><button id="mClose" class="btn ghost">Cancel</button></div>`);
  qs('#mClose').addEventListener('click', closeModal);
  qs('#mReg').addEventListener('click', ()=> {
    const email = qs('#mEmail').value.trim(), pass = qs('#mPass').value;
    const name = prompt('Full name (for register)', email.split('@')[0] || 'User');
    try { register(name, email, pass); alert('Registered'); closeModal(); } catch(e){ alert(e.message); }
  });
  qs('#mLogin').addEventListener('click', ()=> {
    const email = qs('#mEmail').value.trim(), pass = qs('#mPass').value;
    try { const u = login(email, pass); alert('Welcome '+u.name); closeModal(); renderUI(); } catch(e){ alert(e.message); }
  });
}
function showLoginModal(){ openLoginModal(); }

/* Quick login/register */
function showLoginModalPreFilled(email, pass){
  openLoginModal();
  qs('#mEmail').value = email||'';
  qs('#mPass').value = pass||'';
}

/* Add board modal */
function openAddBoardModal(){
  openModal(`<h3>Create New Board</h3><div><input id="nbTitle" class="input" placeholder="Board title" /></div><div><textarea id="nbDesc" class="input" placeholder="Description"></textarea></div><div style="display:flex;gap:8px;margin-top:12px"><button id="nbCreate" class="btn">Create</button><button id="nbClose" class="btn ghost">Cancel</button></div>`);
  qs('#nbClose').addEventListener('click', closeModal);
  qs('#nbCreate').addEventListener('click', ()=> {
    const t = qs('#nbTitle').value.trim(), d = qs('#nbDesc').value.trim();
    if (!t) return alert('Title required');
    createBoard(t,d); closeModal();
    renderUI();
  });
}

/* Add list */
function openAddListModal(board){
  openModal(`<h3>Add List</h3><div><input id="nlTitle" class="input" placeholder="List title" /></div><div style="display:flex;gap:8px;margin-top:12px"><button id="nlSave" class="btn">Add</button><button id="nlClose" class="btn ghost">Cancel</button></div>`);
  qs('#nlClose').addEventListener('click', closeModal);
  qs('#nlSave').addEventListener('click', ()=> {
    const title = qs('#nlTitle').value.trim(); if (!title) return alert('Title required');
    addList(board.id, title); closeModal();
  });
}

/* Add card */
function openAddCardModal(board, list){
  openModal(`<h3>New Card</h3><div><input id="ncTitle" class="input" placeholder="Card title" /></div><div><textarea id="ncDesc" class="input" placeholder="Description"></textarea></div><div style="display:flex;gap:8px;margin-top:12px"><button id="ncSave" class="btn">Add</button><button id="ncClose" class="btn ghost">Cancel</button></div>`);
  qs('#ncClose').addEventListener('click', closeModal);
  qs('#ncSave').addEventListener('click', ()=> {
    const t = qs('#ncTitle').value.trim(); const d = qs('#ncDesc').value.trim();
    if (!t) return alert('Title required');
    addCard(board.id, list.id, t, d); closeModal();
  });
}

/* Card detail modal */
function openCardModal(boardId, listId, cardId){
  const u = findUser(current.email); const b = u.boards.find(x=>x.id===boardId); const l = b.lists.find(x=>x.id===listId); const c = l.cards.find(x=>x.id===cardId);
  openModal(`<h3>Edit Card</h3>
    <div><input id="cTitle" class="input" value="${escapeHtmlAttr(c.title)}" /></div>
    <div><textarea id="cDesc" class="input">${escapeHtmlAttr(c.desc||'')}</textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px"><input id="cDue" class="input" placeholder="Due (ISO or text)" value="${c.due||''}" /></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="cSave" class="btn">Save</button><button id="cClose" class="btn ghost">Cancel</button></div>
    <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)">
    <h4>Comments</h4><div id="comments" style="max-height:160px;overflow:auto;padding:6px"></div>
    <div style="display:flex;gap:8px;margin-top:8px"><input id="commentInput" class="input" placeholder="Write a comment" /><button id="addComment" class="btn">Add</button></div>`);
  qs('#cClose').addEventListener('click', closeModal);
  qs('#cSave').addEventListener('click', ()=> {
    c.title = qs('#cTitle').value.trim() || c.title;
    c.desc = qs('#cDesc').value.trim();
    c.due = qs('#cDue').value.trim() || null;
    saveUsers(); logActivity(current.email,'edit_card',{boardId,listId,cardId}); broadcast({ type:'boards_changed', email:current.email });
    renderBoardColumns(b); closeModal();
  });
  function renderComments(){
    const cont = qs('#comments'); cont.innerHTML = '';
    (c.comments||[]).forEach(cm=>{
      const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
      d.innerHTML = `<div style="font-weight:700">${escapeHtml(cm.author||'Anon')}</div><div style="color:var(--muted);font-size:13px">${escapeHtml(cm.text)}</div><div style="color:var(--muted);font-size:11px">${new Date(cm.ts).toLocaleString()}</div>`;
      cont.appendChild(d);
    });
  }
  renderComments();
  qs('#addComment').addEventListener('click', ()=> {
    const txt = qs('#commentInput').value.trim(); if (!txt) return;
    c.comments = c.comments || []; c.comments.push({ id: uid(6), author: current.email, text: txt, ts: now() }); saveUsers(); renderComments(); qs('#commentInput').value=''; logActivity(current.email,'comment',{boardId,listId,cardId}); broadcast({ type:'boards_changed', email:current.email });
  });
}

/* ---------- Board options ---------- */
function showBoardOptions(board){
  openModal(`<h3>Board Options</h3>
    <div><input id="optTitle" class="input" value="${escapeHtmlAttr(board.title)}" /></div>
    <div><textarea id="optDesc" class="input">${escapeHtmlAttr(board.desc||'')}</textarea></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="optSave" class="btn">Save</button><button id="optDelete" class="btn ghost">Delete</button><button id="optClose" class="btn ghost">Cancel</button></div>`);
  qs('#optClose').addEventListener('click', closeModal);
  qs('#optSave').addEventListener('click', ()=> {
    const t = qs('#optTitle').value.trim(); const d = qs('#optDesc').value.trim();
    const u = findUser(current.email); const b = u.boards.find(x=>x.id===board.id);
    if (!b) return;
    b.title = t; b.desc = d; saveUsers(); logActivity(current.email,'update_board',{boardId:b.id}); broadcast({ type:'boards_changed', email:current.email });
    renderSidebarBoards(); renderBoardsGrid(); closeModal();
  });
  qs('#optDelete').addEventListener('click', ()=> {
    if (!confirm('Delete board?')) return;
    const u = findUser(current.email); u.boards = u.boards.filter(x=>x.id!==board.id); saveUsers(); logActivity(current.email,'delete_board',{boardId:board.id}); broadcast({ type:'boards_changed', email:current.email });
    renderSidebarBoards(); renderBoardsGrid(); closeModal();
  });
}

/* ---------- Export / Import ---------- */
btnExport.addEventListener('click', ()=> {
  const data = { users, activity, exportedAt: now() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `trello_cyberpunk_export_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
});
el('btnImport').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=> {
  const f = e.target.files[0]; if (!f) return;
  const fr = new FileReader(); fr.onload = (ev)=> {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.users) users = data.users;
      if (data.activity) activity = data.activity;
      saveUsers(); saveActivity(); alert('Imported'); renderUI();
    } catch(err){ alert('Invalid file'); }
  }; fr.readAsText(f);
});

/* ---------- Broadcast handler ---------- */
function handleBroadcast(msg){
  if (!msg) return;
  if (msg.type === 'boards_changed' && current && msg.email === current.email) {
    // reload and rerender
    users = JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
    renderSidebarBoards(); renderBoardsGrid(); if (el('boardPanel').style.display !== 'none') {
      // re-render opened board if currently on it
      const title = boardTitleRef.textContent;
      const u = findUser(current.email); const b = (u.boards||[]).find(x=>x.title===title);
      if (b) renderBoardColumns(b);
    }
  }
  if (msg.type === 'auth') {
    // ignore for now
  }
}

/* ---------- small helpers ---------- */
function escapeHtml(s){ if (!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeHtmlAttr(s){ if (!s) return ''; return String(s).replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

/* ---------- UI bindings ---------- */
btnNewBoard.addEventListener('click', ()=> {
  if (!current) return showLoginModal();
  openAddBoardModal();
});
btnBack.addEventListener('click', ()=> { show(el('dashPanel')); hide(el('boardPanel')); renderUI(); });
btnAddList.addEventListener('click', ()=> {
  const u = findUser(current.email); const b = u.boards.find(x=>x.title === boardTitleRef.textContent);
  if (!b) return;
  openAddListModal(b);
});
btnBoardExport.addEventListener('click', ()=> {
  const u = findUser(current.email); const b = u.boards.find(x=>x.title === boardTitleRef.textContent);
  if (!b) return;
  const blob = new Blob([JSON.stringify(b, null, 2)], { type:'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `board_${b.title.replaceAll(' ','_')}.json`; a.click();
});
qs('#globalSearch').addEventListener('input', (e)=> {
  const q = e.target.value.trim().toLowerCase();
  if (!current) return;
  const u = findUser(current.email);
  const matched = (u.boards||[]).filter(b=> b.title.toLowerCase().includes(q) || (b.lists||[]).some(l=> l.title.toLowerCase().includes(q) || l.cards.some(c=> c.title.toLowerCase().includes(q) || (c.desc||'').toLowerCase().includes(q))));
  boardsGridRef.innerHTML = '';
  matched.forEach(b=>{
    const card = document.createElement('div'); card.className='board-card';
    card.innerHTML = `<div><div style="font-weight:800">${escapeHtml(b.title)}</div><div style="color:var(--muted);font-size:12px">${escapeHtml(b.desc||'')}</div></div><div style="display:flex;justify-content:space-between;align-items:center"><div class="meta">${(b.lists||[]).length} lists</div><div style="display:flex;gap:6px"><button class="btn small ghost open">Open</button></div></div>`;
    card.querySelector('.open').addEventListener('click', ()=> openBoard(b.id));
    boardsGridRef.appendChild(card);
  });
});

/* ---------- show login quick ---------- */
function showLoginModal(){
  openLoginModal();
}

/* ---------- On load ---------- */
renderUI();

/* Expose some for debugging */
window.TC = { users, current, createBoard, addList, addCard, moveCard, saveUsers };
</script>
</body>
</html>
